<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Web Oscilloscope</title>

<style>
body {
  margin: 0;
  background: #0b0f14;
  color: #e6edf3;
  font-family: system-ui, sans-serif;
  display: grid;
  place-items: center;
  min-height: 100vh;
}
.wrap {
  width: min(1000px, 92vw);
  background: #0f1620;
  border: 1px solid #1f2a37;
  border-radius: 16px;
  padding: 16px;
}
h1 { margin: 0 0 8px; font-size: 18px; }
canvas {
  width: 100%;
  height: 320px;
  background: #071018;
  border-radius: 12px;
}
.controls {
  display: grid;
  gap: 12px;
  margin-top: 14px;
}
button, select, input {
  background: #111b28;
  color: #e6edf3;
  border: 1px solid #2b3a4e;
  border-radius: 10px;
  padding: 8px 10px;
}
.row { display: flex; gap: 10px; flex-wrap: wrap; }
.stat {
  font-family: ui-monospace, monospace;
  font-size: 12px;
  color: #9fb0c0;
}
</style>
</head>

<body>
<div class="wrap">
  <h1>Audio Oscilloscope</h1>

  <canvas id="scope"></canvas>

  <div class="controls">
    <div class="row">
      <select id="source">
        <option value="mic">Microphone</option>
        <option value="tone">Tone Generator</option>
        <option value="audio1">Audio file 1</option>
        <option value="audio2">Audio file 2</option>
        <option value="audio3">Audio file 3</option>
      </select>

      <select id="waveType">
        <option value="sine">Sine</option>
        <option value="square">Square</option>
      </select>

      <input id="freq" type="number" value="440" min="20" max="20000">
    </div>

    <div class="row">
      <button id="start">Start</button>
      <button id="stop">Stop</button>
    </div>

    <div class="stat" id="status">Status: idle</div>
  </div>
</div>

<!-- Hidden audio players -->
<audio id="audio1" src="audio1.mp3" crossorigin="anonymous"></audio>
<audio id="audio2" src="audio2.mp3" crossorigin="anonymous"></audio>
<audio id="audio3" src="audio3.mp3" crossorigin="anonymous"></audio>

<script>
const canvas = document.getElementById("scope");
const ctx = canvas.getContext("2d");

const startBtn = document.getElementById("start");
const stopBtn = document.getElementById("stop");
const sourceSel = document.getElementById("source");
const waveSel = document.getElementById("waveType");
const freqInput = document.getElementById("freq");
const statusEl = document.getElementById("status");

const audioEls = {
  audio1: document.getElementById("audio1"),
  audio2: document.getElementById("audio2"),
  audio3: document.getElementById("audio3")
};

let audioCtx, analyser, osc, micStream, srcNode;
let dataArray, raf;

function resize() {
  const dpr = devicePixelRatio || 1;
  const r = canvas.getBoundingClientRect();
  canvas.width = r.width * dpr;
  canvas.height = r.height * dpr;
}
window.addEventListener("resize", resize);
resize();

function drawGrid() {
  const w = canvas.width, h = canvas.height;
  ctx.fillStyle = "#071018";
  ctx.fillRect(0,0,w,h);
  ctx.strokeStyle = "rgba(255,255,255,0.1)";
  for (let i=1;i<10;i++){
    ctx.beginPath();
    ctx.moveTo(w*i/10,0);
    ctx.lineTo(w*i/10,h);
    ctx.stroke();
  }
  ctx.beginPath();
  ctx.moveTo(0,h/2);
  ctx.lineTo(w,h/2);
  ctx.stroke();
}

function render() {
  analyser.getByteTimeDomainData(dataArray);
  drawGrid();

  ctx.strokeStyle = "#84ccff";
  ctx.lineWidth = 2;
  ctx.beginPath();

  const w = canvas.width, h = canvas.height;
  for (let i=0;i<dataArray.length;i++){
    const x = i / (dataArray.length-1) * w;
    const v = (dataArray[i]-128)/128;
    const y = h/2 - v*h*0.4;
    i===0 ? ctx.moveTo(x,y) : ctx.lineTo(x,y);
  }
  ctx.stroke();
  raf = requestAnimationFrame(render);
}

async function start() {
  stop();
  audioCtx = new AudioContext();
  analyser = audioCtx.createAnalyser();
  analyser.fftSize = 2048;
  dataArray = new Uint8Array(analyser.fftSize);

  const src = sourceSel.value;

  if (src === "mic") {
    micStream = await navigator.mediaDevices.getUserMedia({audio:true});
    srcNode = audioCtx.createMediaStreamSource(micStream);
  }
  else if (src === "tone") {
    osc = audioCtx.createOscillator();
    osc.type = waveSel.value;
    osc.frequency.value = freqInput.value;
    srcNode = osc;
    osc.start();
  }
  else {
    const el = audioEls[src];
    el.currentTime = 0;
    el.play();
    srcNode = audioCtx.createMediaElementSource(el);
  }

  srcNode.connect(analyser);
  analyser.connect(audioCtx.destination);

  statusEl.textContent = "Status: running (" + src + ")";
  raf = requestAnimationFrame(render);
}

function stop() {
  cancelAnimationFrame(raf);
  if (osc) { osc.stop(); osc.disconnect(); osc=null; }
  if (micStream) {
    micStream.getTracks().forEach(t=>t.stop());
    micStream=null;
  }
  Object.values(audioEls).forEach(a=>a.pause());
  if (audioCtx) audioCtx.close();
  drawGrid();
  statusEl.textContent = "Status: stopped";
}

startBtn.onclick = start;
stopBtn.onclick = stop;
drawGrid();
</script>
</body>
</html>
